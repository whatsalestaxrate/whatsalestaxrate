<!DOCTYPE html>
<html>
<head>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
<script src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v4.4.2/mapbox-gl-geocoder.min.js"></script>
<meta name="keywords" content="Sales Tax, Small Business, Sales Tax Rate, Sales Tax Map">
<title>What Sales Tax Rate - Map</title>
<meta name="description" content="Sales Tax Rate Map">
<meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no" />
<script src="https://api.mapbox.com/mapbox-gl-js/v1.7.0/mapbox-gl.js"></script>
<link href="https://fonts.googleapis.com/css?family=Roboto+Mono|Sen&display=swap" rel="stylesheet">
<link href="https://api.mapbox.com/mapbox-gl-js/v1.7.0/mapbox-gl.css" rel="stylesheet" />
<link
rel="stylesheet"
href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v4.4.2/mapbox-gl-geocoder.css"
type="text/css"
/>
<style>
	body { margin: 0; padding: 0; background-color: #33FFBD; font-family: 'Sen', sans-serif; }
	span {font-family: 'Roboto Mono', monospace;}
	.mapboxgl-popup-content{background-color: rgba(255, 255, 255, .90);}
</style>
</head>
<script>
//const sleep = (milliseconds) => {
//	return new Promise(resolve => setTimeout(resolve, milliseconds))
//}
//Code from Mapbox public documentation & samples and my janky fixes to make this do what I was trying to get it to do.
$(document).ready(function(){
mapboxgl.accessToken = 'pk.eyJ1IjoibWJveDQiLCJhIjoiY2s2ZWFsNjJpMWl6ZzNucnp6cjk0OTd3YiJ9.bC8QM1grbQDTKPZP-y2Dpg';
var map = new mapboxgl.Map({
container: 'map', // container id
style: 'mapbox://styles/mapbox/streets-v11',
center: [-98.5795, 39.8283], // starting position
zoom: 4 // starting zoom
});
var coordinatesGeocoder = function(query) {
// match anything which looks like a decimal degrees coordinate pair
var matches = query.match(
/^[ ]*(?:Lat: )?(-?\d+\.?\d*)[, ]+(?:Lng: )?(-?\d+\.?\d*)[ ]*$/i
);
if (!matches) {
return null;
}
function coordinateFeature(lng, lat) {
return {
center: [lng, lat],
geometry: {
type: 'Point',
coordinates: [lng, lat]
},
place_name: 'Lat: ' + lat + ' Lng: ' + lng,
place_type: ['coordinate'],
properties: {},
type: 'Feature'
};
}
var coord1 = Number(matches[1]);
var coord2 = Number(matches[2]);
var geocodes = [];
if (coord1 < -90 || coord1 > 90) {
// must be lng, lat
geocodes.push(coordinateFeature(coord1, coord2));
}
if (coord2 < -90 || coord2 > 90) {
// must be lat, lng
geocodes.push(coordinateFeature(coord2, coord1));
}
if (geocodes.length === 0) {
// else could be either lng, lat or lat, lng
geocodes.push(coordinateFeature(coord1, coord2));
geocodes.push(coordinateFeature(coord2, coord1));
} 
return geocodes;
};
map.addControl(
new mapboxgl.GeolocateControl({
positionOptions: {
enableHighAccuracy: true
},
trackUserLocation: true
})
); 
map.addControl(new mapboxgl.NavigationControl());
map.addControl(
new MapboxGeocoder({
accessToken: mapboxgl.accessToken,
position: 'top-right',
localGeocoder: coordinatesGeocoder,
placeholder: 'Address or Lat,Long',
mapboxgl: mapboxgl
}),'top-left'
);
var truedo = true;

	map.on('click', function(e) {
	if (truedo) {
	var coordinates = e.lngLat;
	var lat = e.lngLat.lat;
	var longi = e.lngLat.lng;
	var description = e.description;
	$.get("https://api.mapbox.com/geocoding/v5/mapbox.places/"+longi+","+lat+".json",{access_token: mapboxgl.accessToken}, function(result2,status2){
		$("span[id=resultspan]").append(result2.features[0].place_name)
		$("span[id=resultspan]").append('<br>')
	});
	$.post("https://www.avalara.com/taxrates/en/state-rates/api/getRateForAddress/", {latitude: lat, longitude: longi} , function(result, status){
		var i;
		$("span[id=resultspan]").append('<br>')
		var running_sum = 0;
		for (i=0;i < result.summary.length; i++){
			running_sum += result.summary[i].rate*100;
			$("span[id=resultspan]").append("<li>"+result.summary[i].jurisName+"="+(result.summary[i].rate*100).toFixed(3)+"%</li>"); 
	}
		$("span[id=resultspan]").append("Total ="+running_sum.toFixed(3)+"%</li><br>");
		$("span[id=resultspan]").append("Lat: ",lat.toFixed(3)," Long: ",longi.toFixed(3));
		$("span[id=resultspan]").append("<hr>Wait 10 seconds for next request. ");
	});
		truedo = false;
		$("div[class=mapboxgl-map]").css("pointer-events", "none");

		
		setTimeout(function(){truedo = true;$("div[class=mapboxgl-map]").css("pointer-events", "auto");$("span[id=resultspan]").append(String.fromCharCode(0x2705));}, 10000);
	
	new mapboxgl.Popup()
	.setLngLat(coordinates)
	.setHTML("<span id='resultspan'></span>")
	.addTo(map);


	}
});

  });

</script>
</head>
<body>
<div id="bottom_bar" style="height:4.5vh;width:100vw; z-index: 1;box-shadow: 0px 5px 5px #888888;z-index: 1;position:relative;background-color: #33FFBD;">
	<p style="font-size: 1em; color:#768F87"> Click map to see US sales tax jurisdictions and rates sourced from public APIs. See disclosures on github<p>
</div>
<div id="map" style="height:93.5vh; width:100vw; position: relative; z-index: 0;"> </div>
</body>
</html>
