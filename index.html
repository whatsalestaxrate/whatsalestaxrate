<!DOCTYPE html>
<html>
<head>
<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-159955625-1"></script>
<script>
	window.dataLayer = window.dataLayer || [];
	function gtag(){dataLayer.push(arguments);}
	gtag('js', new Date());

	gtag('config', 'UA-159955625-1');
</script>
<script src="https://cdn.jsdelivr.net/npm/progressbar.js@1.0.1/dist/progressbar.min.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
<script src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v4.4.2/mapbox-gl-geocoder.min.js"></script>
<meta name="keywords" content="Sales Tax, Small Business, Sales Tax Rate, Sales Tax Map">
<title>What Sales Tax Rate - Map</title>
<meta name="description" content="Sales Tax Rate Map">
<meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no" />
<script src="https://api.mapbox.com/mapbox-gl-js/v1.7.0/mapbox-gl.js"></script>
<link href="https://fonts.googleapis.com/css?family=Roboto+Mono|Sen&display=swap" rel="stylesheet">
<link href="https://api.mapbox.com/mapbox-gl-js/v1.7.0/mapbox-gl.css" rel="stylesheet" />
<link
rel="stylesheet"
href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v4.4.2/mapbox-gl-geocoder.css"
type="text/css"
/>
<style>
	body { margin: 0; padding: 0; background-color: #33FFBD; font-family: 'Sen', sans-serif; -webkit-text-size-adjust: 100%;
		-ms-text-size-adjust: none; }
	span {font-family: 'Roboto Mono', monospace;}
	.mapboxgl-popup-content{background-color: rgba(255, 255, 255, .90);}
	
	@supports(padding: max(0px)) {
    #bottom_bar {
        padding-right: max(0px, env(safe-area-inset-right));
    }
    #top_bar {
        padding-left: max(0px, env(safe-area-inset-left));
    }
	.progress {
		height: 3em;
		width: 3em;
	}
	.progress > svg {
		height: 100%;
		display: fixed;
	}

}
#wrapper{
height:100vh;
height:calc(var(--vh,1vh)*100);

}

#bottom_bar{
	max-height: 25%;
	
}
	
</style>
</head>
<script>
//const sleep = (milliseconds) => {
//	return new Promise(resolve => setTimeout(resolve, milliseconds))
//}
//Code from Mapbox public documentation & samples and my janky fixes to make this do what I was trying to get it to do.
$(document).ready(function(){
	

	
let vh = window.innerHeight * 0.01;
document.documentElement.style.setProperty('--vh',`${vh}px`);


$(window).on('resize',function(){

let vh = window.innerHeight * 0.01;
document.documentElement.style.setProperty('--vh',`${vh}px`);
});



$("#top_bar > h1").click(function(){
	
	$("#keeptrack").toggle("fast","swing");
	
});
mapboxgl.accessToken = 'pk.eyJ1IjoibWJveDQiLCJhIjoiY2s2ZWFsNjJpMWl6ZzNucnp6cjk0OTd3YiJ9.bC8QM1grbQDTKPZP-y2Dpg';
var map = new mapboxgl.Map({
container: 'map', // container id
style: 'mapbox://styles/mapbox/streets-v11',
center: [-98.5795, 39.8283], // starting position
zoom: 4 // starting zoom
});
var coordinatesGeocoder = function(query) {
// match anything which looks like a decimal degrees coordinate pair
var matches = query.match(
/^[ ]*(?:Lat: )?(-?\d+\.?\d*)[, ]+(?:Lng: )?(-?\d+\.?\d*)[ ]*$/i
);
if (!matches) {
return null;
}
function coordinateFeature(lng, lat) {
return {
center: [lng, lat],
geometry: {
type: 'Point',
coordinates: [lng, lat]
},
place_name: 'Lat: ' + lat + ' Lng: ' + lng,
place_type: ['coordinate'],
properties: {},
type: 'Feature'
};
}
var coord1 = Number(matches[1]);
var coord2 = Number(matches[2]);
var geocodes = [];
if (coord1 < -90 || coord1 > 90) {
// must be lng, lat
geocodes.push(coordinateFeature(coord1, coord2));
}
if (coord2 < -90 || coord2 > 90) {
// must be lat, lng
geocodes.push(coordinateFeature(coord2, coord1));
}
if (geocodes.length === 0) {
// else could be either lng, lat or lat, lng
geocodes.push(coordinateFeature(coord1, coord2));
geocodes.push(coordinateFeature(coord2, coord1));
} 
return geocodes;
};
map.addControl(
new mapboxgl.GeolocateControl({
positionOptions: {
enableHighAccuracy: true
},
trackUserLocation: true
})
); 
map.addControl(new mapboxgl.NavigationControl());
map.addControl(
new MapboxGeocoder({
accessToken: mapboxgl.accessToken,
position: 'top-right',
localGeocoder: coordinatesGeocoder,
placeholder: 'Address or Lat,Long',
mapboxgl: mapboxgl
}),'top-left'
);
var counter = 0;
map.on('click', function(e) {
	
	counter++;
	var coordinates = e.lngLat;
	var lat = e.lngLat.lat;
	var longi = e.lngLat.lng;
	var description = e.description;

	new mapboxgl.Popup()
	.setLngLat(coordinates)
	.setHTML("<div id='progress' class='progress'></div>")
	.addTo(map);
	var circle = new ProgressBar.Circle('#progress', {
		color: '#FCB03C',
		duration: 9999,
		easing: 'easeInOut',
		color: 'blue',
		strokeWidth: 6
	});

	circle.animate(1);
	setTimeout(function(){
		$("#progress").remove();
		$.get("https://api.mapbox.com/geocoding/v5/mapbox.places/"+longi+","+lat+".json",{access_token: mapboxgl.accessToken}, function(result2,status2){
			$("#resultspan").append(result2.features[0].place_name)
			$("#resultspan").append('<br>')
		});
		$.post("https://www.avalara.com/taxrates/en/state-rates/api/getRateForAddress/", {latitude: lat, longitude: longi} , function(result, status){
			var i;
			$("#resultspan").append('<br>')
			var running_sum = 0;
			for (i=0;i < result.summary.length; i++){
				running_sum += result.summary[i].rate*100;
				$("#resultspan").append("<li>"+result.summary[i].jurisName+"="+(result.summary[i].rate*100).toFixed(3)+"%</li>"); 
			}
			$("#resultspan").append("Total ="+running_sum.toFixed(3)+"%</li><br>");
			$("#resultspan").append("Lat: ",lat.toFixed(3)," Long: ",longi.toFixed(3));
			$("#resultspan").append("<br>")
			$("#keeptrack").append($("#resultspan").html());
			$("#keeptrack").append("<hr>");	
		});
		
		new mapboxgl.Popup()
			.setHTML("<span id='resultspan'></span>")
			.setLngLat(coordinates)
			.addTo(map)
		
			
	}, 10000);
	
	
	
});

  });

</script>
</head>
<body>
<div id="wrapper" style="display:flex;flex-flow:column;">
<div id="top_bar" style="width:100vw; z-index: 1;box-shadow: 0px -5px -5px #888888;z-index: 1;background-color: #33FFBD;flex: 0 1 auto;display:flex;color:#768F87">
	<h1 style="font-size: 85%;"> Click map to see US sales tax jurisdictions and rates sourced from public APIs. See disclosures before use on <a href='https://github.com/whatsalestaxrate/whatsalestaxrate/blob/master/README.md'>github</a></h1>
</div>
<div id="map" style="height:100%;width:100vw; z-index: 0;flex: 1 1 auto"> </div>
<div id="bottom_bar" style="flex: 0 1 auto;color:#768F87;display:flex;"><span id="keeptrack" style="display:none;"></span></div>
</div>

</body>
</html>
