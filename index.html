<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1, user-scalable=no">

    <!-- Meta Information -->
    <title>Sales Tax Rate Map - What Sales Tax Rate</title>
    <meta name="description" content="Interactive map to find sales tax rates across the United States by clicking or searching.">
    <meta name="keywords" content="Sales Tax, Small Business, Sales Tax Rate, Sales Tax Map, Shipping, Drop Ship, United States, Tax Rate Lookup">

    <!-- CSS Dependencies -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/semantic-ui@2.4.2/dist/semantic.min.css">
    <link href="https://api.mapbox.com/mapbox-gl-js/v1.13.0/mapbox-gl.css" rel="stylesheet" /> <!-- Updated Mapbox Version -->
    <link rel="stylesheet" href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v4.7.2/mapbox-gl-geocoder.css" type="text/css" /> <!-- Updated Geocoder Version -->
    <link href="https://fonts.googleapis.com/css?family=Roboto+Mono|Sen&display=swap" rel="stylesheet">

    <!-- Google Analytics (Async) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-159955625-1"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'UA-159955625-1');
    </script>

    <!-- Internal Styles -->
    <style>
        :root {
             /* Define viewport height variable for mobile browsers */
            --vh: 1vh;
        }

        html, body {
            height: 100%; /* Ensure html and body take full height */
            margin: 0;
            padding: 0;
            overflow: hidden; /* Prevent scrollbars on the body */
            font-family: 'Sen', sans-serif;
            background-color: #f4f4f4; /* Lighter background for less harsh contrast */
            -webkit-text-size-adjust: 100%;
            -ms-text-size-adjust: none;
        }

        #wrapper {
            display: flex;
            flex-direction: column;
            height: 100vh; /* Fallback for older browsers */
            height: calc(var(--vh, 1vh) * 100); /* Use dynamic viewport height */
        }

        #menu {
            flex-shrink: 0; /* Prevent menu from shrinking */
            /* Semantic UI handles fixed positioning and styling */
        }

        #map-container {
            flex-grow: 1; /* Allow map container to fill remaining space */
            position: relative; /* Needed for map overlay/absolute positioning */
            overflow: hidden; /* Hide any map overflow */
        }

        #map {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 100%;
            height: 100%;
        }

        /* Style popups */
        .mapboxgl-popup-content {
            background-color: rgba(255, 255, 255, .95); /* Slightly less transparent */
            padding: 15px;
            box-shadow: 0 1px 4px rgba(0, 0, 0, .1);
            border-radius: 4px;
            font-family: 'Sen', sans-serif;
        }

        .mapboxgl-popup-content h4 {
            margin: 0 0 10px 0;
            font-weight: bold;
            color: #333;
        }

        .mapboxgl-popup-content ul {
            list-style: none;
            padding: 0;
            margin: 0 0 10px 0;
        }
         .mapboxgl-popup-content li {
            margin-bottom: 5px;
            font-size: 0.9em;
         }
        .mapboxgl-popup-content .tax-jurisdiction {
             font-family: 'Sen', sans-serif;
        }
        .mapboxgl-popup-content .tax-rate {
            font-family: 'Roboto Mono', monospace;
            font-weight: bold;
        }
         .mapboxgl-popup-content .tax-total {
            font-weight: bold;
            margin-top: 8px;
            border-top: 1px solid #eee;
            padding-top: 8px;
         }
        .mapboxgl-popup-content .coordinates {
            font-family: 'Roboto Mono', monospace;
            font-size: 0.8em;
            color: #555;
            margin-top: 10px;
        }

        /* Style the log area if needed (currently hidden/unused in this refactor) */
        /* #keeptrack { ... } */

        /* Geocoder styling */
        .mapboxgl-ctrl-geocoder {
             font-size: 14px;
             max-width: none;
             width: 100%;
             border: 1px solid #ccc;
             box-shadow: none;
        }
        .mapboxgl-ctrl-geocoder input[type='text'] {
            height: 38px; /* Match Semantic UI input height */
            padding: 0 10px;
        }
        .mapboxgl-ctrl-geocoder .mapboxgl-ctrl-geocoder--icon-search {
            top: 9px; /* Adjust icon position */
        }

    </style>
</head>
<body>

    <div id="wrapper">

        <div id="menu" class="ui inverted fixed menu">
            <div class="ui fluid container">
                <span class="item active">Sales Tax Map</span> <!-- Use span if not a link -->
                <a class="item" href='https://github.com/whatsalestaxrate/whatsalestaxrate/blob/master/README.md' target="_blank" rel="noopener noreferrer">GitHub Source & Disclosures</a>
                <!-- Add rel="noopener noreferrer" for security on target="_blank" -->
                <!-- Coinwidget removed as commented out in original -->
            </div>
        </div>

        <!-- Use a container for the map to handle layout relative to the menu -->
        <div id="map-container">
             <div id="map"></div>
        </div>

        <!-- Keep track div (Optional - currently not used in popup logic, maybe for a separate log?) -->
        <!-- <div id="keeptrack" style="display: none;"></div> -->

    </div><!-- /#wrapper -->

    <!-- JavaScript Dependencies (Load at the end) -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/semantic-ui@2.4.2/dist/semantic.min.js"></script>
    <script src="https://api.mapbox.com/mapbox-gl-js/v1.13.0/mapbox-gl.js"></script> <!-- Updated Mapbox Version -->
    <script src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v4.7.2/mapbox-gl-geocoder.min.js"></script> <!-- Updated Geocoder Version -->
    <!-- Coinwidget script removed -->

    <!-- Main Application Logic -->
    <script>
        // Wait for the DOM to be fully loaded
        document.addEventListener('DOMContentLoaded', () => {

            // --- Configuration ---
            const MAPBOX_ACCESS_TOKEN = 'pk.eyJ1IjoibWJveDQiLCJhIjoiY2s2ZWFsNjJpMWl6ZzNucnp6cjk0OTd3YiJ9.bC8QM1grbQDTKPZP-y2Dpg'; // Keep token here or move to env variable for build process
            const TAX_API_PROXY_URL = "https://turnkey-resolver.onrender.com/turnkey"; // Proxy URL to avoid CORS and hide potential target API keys
            const AVALARA_TAX_URL_BASE = "https://avatax-prod.avlr.net/avalara/avatax/getresponse"; // Base URL for the tax service

            // --- Helper Functions ---

            // Recalculate VH unit for mobile browser address bars
            const calculateVh = () => {
                let vh = window.innerHeight * 0.01;
                document.documentElement.style.setProperty('--vh', `${vh}px`);
            };

            // Function to create HTML content for the popup
            const createPopupHtml = (locationName, taxData, lat, lng) => {
                let popupHtml = `<h4>${locationName || 'Selected Location'}</h4>`;
                let running_sum = 0;

                if (taxData && taxData.summary && taxData.summary.length > 0) {
                    popupHtml += `<ul>`;
                    taxData.summary.forEach(item => {
                        const taxRate = parseFloat(item.taxCalculated) || 0; // Ensure it's a number
                        running_sum += taxRate;
                        popupHtml += `<li><span class="tax-jurisdiction">${item.jurisName}:</span> <span class="tax-rate">${taxRate.toFixed(3)}%</span></li>`;
                    });
                    popupHtml += `</ul>`;
                    popupHtml += `<div class="tax-total">Total: <span class="tax-rate">${running_sum.toFixed(3)}%</span></div>`;
                } else {
                    popupHtml += `<p>No tax summary data found for this location.</p>`;
                }

                popupHtml += `<div class="coordinates">Lat: ${lat.toFixed(5)}, Lng: ${lng.toFixed(5)}</div>`;
                return popupHtml;
            };

            // Function to handle coordinate input in geocoder (from original code)
            const coordinatesGeocoder = (query) => {
                // match anything which looks like a decimal degrees coordinate pair
                const matches = query.match(
                    /^[ ]*(?:Lat: )?(-?\d+\.?\d*)[, ]+(?:Lng: )?(-?\d+\.?\d*)[ ]*$/i
                );
                if (!matches) {
                    return null;
                }
                function coordinateFeature(lng, lat) {
                    return {
                        center: [lng, lat],
                        geometry: { type: 'Point', coordinates: [lng, lat] },
                        place_name: 'Lat: ' + lat + ' Lng: ' + lng,
                        place_type: ['coordinate'],
                        properties: {},
                        type: 'Feature'
                    };
                }
                const coord1 = Number(matches[1]);
                const coord2 = Number(matches[2]);
                const geocodes = [];
                // Assume lng, lat if first coord is outside lat bounds
                if (coord1 < -180 || coord1 > 180 || coord2 < -90 || coord2 > 90) {
                     // Basic validation if coords look like lat/lon
                     if (coord1 >= -90 && coord1 <= 90 && coord2 >= -180 && coord2 <= 180) {
                         // Guessing coord1 is lat, coord2 is lng
                         geocodes.push(coordinateFeature(coord2, coord1));
                     }
                      if (coord2 >= -90 && coord2 <= 90 && coord1 >= -180 && coord1 <= 180) {
                         // Guessing coord1 is lng, coord2 is lat
                         geocodes.push(coordinateFeature(coord1, coord2));
                    }
                } else {
                    // If numbers are within standard ranges, could be either way
                     geocodes.push(coordinateFeature(coord1, coord2)); // lng, lat
                     geocodes.push(coordinateFeature(coord2, coord1)); // lat, lng
                }

                return geocodes;
            };


            // --- Initialization ---

            // Initial VH calculation
            calculateVh();

            // Mapbox Setup
            mapboxgl.accessToken = MAPBOX_ACCESS_TOKEN;
            const map = new mapboxgl.Map({
                container: 'map', // container id
                style: 'mapbox://styles/mapbox/satellite-streets-v11', // Consider other styles like 'streets-v11' if satellite isn't needed
                center: [-98.5795, 39.8283], // USA center
                zoom: 4
            });

            // --- Map Controls ---
            map.addControl(new mapboxgl.NavigationControl());
            map.addControl(
                new mapboxgl.GeolocateControl({
                    positionOptions: { enableHighAccuracy: true },
                    trackUserLocation: true
                })
            );
            map.addControl(
                new MapboxGeocoder({
                    accessToken: mapboxgl.accessToken,
                    localGeocoder: coordinatesGeocoder, // Use the custom coordinate parser
                    placeholder: 'Address or Lat, Lng',
                    mapboxgl: mapboxgl,
                    marker: false // Don't add a marker automatically on geocode result
                }),
                'top-left' // Position geocoder
            );

            // --- Event Listeners ---

            // Recalculate VH on resize/orientation change
            window.addEventListener('resize', calculateVh);
            window.addEventListener('orientationchange', calculateVh);

            // Handle Map Clicks
            map.on('click', (e) => {
                const { lng, lat } = e.lngLat;
                let popup = null; // Hold reference to the popup

                 // Show a temporary loading popup
                popup = new mapboxgl.Popup({ closeButton: false, closeOnClick: false })
                    .setLngLat(e.lngLat)
                    .setHTML('<em>Loading tax data...</em>')
                    .addTo(map);

                // 1. Reverse Geocode to get location name (using Mapbox API)
                const geocodeUrl = `https://api.mapbox.com/geocoding/v5/mapbox.places/${lng},${lat}.json?access_token=${mapboxgl.accessToken}`;

                $.get(geocodeUrl)
                    .done((geocodeResult) => {
                        const locationName = (geocodeResult.features && geocodeResult.features.length > 0)
                            ? geocodeResult.features[0].place_name
                            : 'Unknown Location';

                        // 2. Get Tax Data via Proxy
                        const taxApiUrl = `${AVALARA_TAX_URL_BASE}?latitude=${lat}&longitude=${lng}`;
                        $.post(TAX_API_PROXY_URL, { url: taxApiUrl })
                            .done((taxResult) => {
                                // Create popup content *after* getting data
                                const popupContent = createPopupHtml(locationName, taxResult, lat, lng);
                                if (popup) {
                                    popup.setHTML(popupContent).options.closeButton = true; // Add close button now
                                    popup.options.closeOnClick = true;
                                } else {
                                     // If initial popup failed somehow, create a new one
                                      new mapboxgl.Popup()
                                        .setLngLat(e.lngLat)
                                        .setHTML(popupContent)
                                        .addTo(map);
                                }

                                // Optional: Log to console or a hidden div
                                // console.log({ locationName, taxData: taxResult, lat, lng });
                                // $("#keeptrack").append(popupContent + "<hr>"); // If you want to keep the log
                            })
                            .fail((taxXhr, taxStatus, taxError) => {
                                console.error("Tax API Error:", taxStatus, taxError, taxXhr.responseText);
                                const errorContent = `<h4>${locationName}</h4><p>Could not retrieve tax data. Please try again later.</p><div class="coordinates">Lat: ${lat.toFixed(5)}, Lng: ${lng.toFixed(5)}</div>`;
                                if (popup) {
                                     popup.setHTML(errorContent).options.closeButton = true;
                                     popup.options.closeOnClick = true;
                                } else {
                                      new mapboxgl.Popup()
                                        .setLngLat(e.lngLat)
                                        .setHTML(errorContent)
                                        .addTo(map);
                                }
                            });
                    })
                    .fail((geocodeXhr, geocodeStatus, geocodeError) => {
                        console.error("Mapbox Geocoding Error:", geocodeStatus, geocodeError);
                         // Still try to get tax data, just without a pretty name
                        const taxApiUrl = `${AVALARA_TAX_URL_BASE}?latitude=${lat}&longitude=${lng}`;
                         $.post(TAX_API_PROXY_URL, { url: taxApiUrl })
                             .done((taxResult) => {
                                 const popupContent = createPopupHtml('Selected Location', taxResult, lat, lng); // Use generic name
                                 if(popup) {
                                    popup.setHTML(popupContent).options.closeButton = true;
                                    popup.options.closeOnClick = true;
                                 } else {
                                     new mapboxgl.Popup()
                                        .setLngLat(e.lngLat)
                                        .setHTML(popupContent)
                                        .addTo(map);
                                 }
                             })
                             .fail((taxXhr, taxStatus, taxError) => {
                                 console.error("Tax API Error (after geocode fail):", taxStatus, taxError);
                                 const errorContent = `<h4>Error</h4><p>Could not retrieve location name or tax data.</p><div class="coordinates">Lat: ${lat.toFixed(5)}, Lng: ${lng.toFixed(5)}</div>`;
                                 if(popup) {
                                    popup.setHTML(errorContent).options.closeButton = true;
                                    popup.options.closeOnClick = true;
                                 } else {
                                      new mapboxgl.Popup()
                                        .setLngLat(e.lngLat)
                                        .setHTML(errorContent)
                                        .addTo(map);
                                 }
                             });
                    });
            });

            // Optional: Handle geocoder result selection if you want to trigger the tax lookup automatically
             const geocoder = map.getControlByClass('mapboxgl-ctrl-geocoder'); // Assuming only one geocoder control
             if (geocoder) {
                 geocoder.on('result', (e) => {
                     if (e.result && e.result.center) {
                         const [lng, lat] = e.result.center;
                         // Simulate a map click at the result's location
                         map.fire('click', { lngLat: { lng, lat } });

                         // Fly map to the location
                         map.flyTo({
                             center: [lng, lat],
                             zoom: 14 // Zoom in closer on geocode result
                         });
                     }
                 });
             }


        }); // End DOMContentLoaded
    </script>

</body>
</html>
